<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!--Имя файла с переменными окружения для использования в post-build event-->
    <!--Этот файл используется для автоматизации типовых операций с помощью скриптов-->
    <PostBuildIncludeDir>$(MSBuildProjectDirectory)\$(IntermediateOutputPath)</PostBuildIncludeDir>
    <IPSClientVarsPath>$(PostBuildIncludeDir)IPSClientVars.bat</IPSClientVarsPath>
  </PropertyGroup>
 
  <Target Name="WriteIPSClientVars" BeforeTargets="PrepareForBuild" DependsOnTargets="ValidateIPSClientSDK" Inputs="$(TargetPath)" Outputs="$(IPSClientVarsPath)">
    <PropertyGroup>
      <!--MSBuild 12 и выше -->
      <IPSClientVarsFxDir Condition="'$(MSBuildFrameworkToolsRoot)' != ''">$(MSBuildFrameworkToolsRoot)$(TargetedRuntimeVersion)\</IPSClientVarsFxDir>
      <!--MSBuild ранних версий -->
      <IPSClientVarsFxDir Condition="'$(MSBuildFrameworkToolsRoot)' == ''">$(MSBuildToolsRoot)$(TargetedRuntimeVersion)\</IPSClientVarsFxDir>
    </PropertyGroup>

    <!--Содержимое .bat-файла с переменными окружения для включения в post-build event-->
    <ItemGroup>
      <IPSClientVarsLine Include=":: !!! This file is autogenerated !!! Do not edit the file. Exclude the file from the version control system."/>
      <IPSClientVarsLine Include=":: Do not edit this file. Exclude this file from the version control system."/>
      <IPSClientVarsLine Include="::"/>

      <IPSClientVarsLine Include="::"/>
      <IPSClientVarsLine Include=":: IPS Client and SDK"/>
      <IPSClientVarsLine Include="set IPS_CLIENT_DIR=$(IPSClientDir)"/>
      <IPSClientVarsLine Include="set IPS_CLIENT_PLUGINS_DIR=$(IPSClientPluginsDir)"/>
      <IPSClientVarsLine Include="set IPS_CLIENT_SDK_DIR=$(IPSClientSDKDir)"/>
      
      <IPSClientVarsLine Include="::"/>
      <IPSClientVarsLine Include=":: Target framework SDK"/>
      <IPSClientVarsLine Include="set MSBUILD_DIR=$(MSBuildToolsPath)\"/>
      <IPSClientVarsLine Include="set SDK_DIR=$(FrameworkSDKRoot)"/>
      <IPSClientVarsLine Include="set FXSDK_DIR=$(TargetFrameworkSDKToolsDirectory)"/>
      <IPSClientVarsLine Include="set FX_DIR=$(IPSClientVarsFxDir)"/>     

      <IPSClientVarsLine Include="::"/>
      <IPSClientVarsLine Include=":: Solution configuration"/>
      <IPSClientVarsLine Include="set SOLUTION_DIR=$(SolutionDir)"/>
      <IPSClientVarsLine Include="set BUILD_CONFIG=$(ConfigurationName)"/>
      <IPSClientVarsLine Include="set BUILD_PLATFORM=$(Platform)"/>

      <IPSClientVarsLine Include="::"/>
      <IPSClientVarsLine Include=":: Project"/>
      <IPSClientVarsLine Include="set PROJECT_PATH=$(ProjectPath)"/>
      <IPSClientVarsLine Include="set PROJECT_DIR=$(ProjectDir)"/>
      <IPSClientVarsLine Include="set PROJECT_NAME=$(ProjectName)"/>
      <IPSClientVarsLine Include="set OUT_DIR=$(OutDir)"/>

      <IPSClientVarsLine Include="::"/>
      <IPSClientVarsLine Include=":: Build target"/>
      <IPSClientVarsLine Include="set TARGET_PATH=$(TargetPath)"/>
      <IPSClientVarsLine Include="set TARGET_DIR=$(TargetDir)"/>
      <IPSClientVarsLine Include="set TARGET_FILENAME=$(TargetFileName)"/>
      <IPSClientVarsLine Include="set TARGET_NAME=$(TargetName)"/>
    </ItemGroup>

    <!--Записываем .bat-файл на диск-->
    <Message Text="Making the post-build event include file $(IPSClientVarsPath)"/>
    <MakeDir Directories="$(PostBuildIncludeDir)"/>
    <WriteLinesToFile File="$(IPSClientVarsPath)" Lines="@(IPSClientVarsLine, '%0d%0a')" Overwrite="true" />
  </Target>

  <Target Name="UpdateIPSClientPluginPreBuildEvent" BeforeTargets="PreBuildEvent" DependsOnTargets="WriteIPSClientVars" Condition="'$(PreBuildEvent)' != ''">
    <PropertyGroup>
      <!--Добавим в pre-build event путь к созданному .bat-файлу в переменную PATH-->
      <NewLine>%0A%0D</NewLine>
      <PreBuildEvent>set PATH=&quot;$(PostBuildIncludeDir)&quot;;%PATH%$(NewLine)$(PreBuildEvent)</PreBuildEvent>
    </PropertyGroup>
  </Target>

  <Target Name="UpdateIPSClientPluginPostBuildEvent" BeforeTargets="PostBuildEvent" DependsOnTargets="WriteIPSClientVars" Condition="'$(PostBuildEvent)' != ''">
    <PropertyGroup>
      <!--Добавим в post-build event путь к созданному .bat-файлу в переменную PATH-->
      <NewLine>%0A%0D</NewLine>
      <PostBuildEvent>set PATH=&quot;$(PostBuildIncludeDir)&quot;;%PATH%$(NewLine)$(PostBuildEvent)</PostBuildEvent>
    </PropertyGroup>
  </Target>

  <Import Project="$(IPSSDKDir)Custom\Client\IPSClientPlugin.*.targets"/>
  <Import Project="$(SolutionDir).ips\IPSClientPlugin.targets" Condition="'$(SolutionDir)' != '' AND Exists('$(SolutionDir).ips\IPSClientPlugin.targets')"/>

</Project>